name: Build Free-mail App

on:
  workflow_dispatch:  # Manual trigger from Actions tab
    inputs:
      version:
        description: 'App version (e.g., 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - latest
          - beta
        default: 'latest'

env:
  BACKEND_URL: ${{ vars.BACKEND_URL }}

jobs:
  build_android:
    name: Build Android
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - run: chmod +x ./set_app_name.sh
      - run: ./set_app_name.sh
      - run: flutter pub get
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ vars.KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          
      - name: Configure Signing
        env:
          KEYSTORE_PASSWORD: ${{ vars.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ vars.KEY_PASSWORD }}
          KEY_ALIAS: ${{ vars.KEY_ALIAS }}
        run: |
          echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          
      - name: Patch build.gradle.kts for signing
        run: |
          cat > android/app/signing.gradle.kts <<'EOF'
          import com.android.build.api.dsl.ApplicationExtension
          
          val keystorePropertiesFile = rootProject.file("key.properties")
          val keystoreProperties = java.util.Properties()
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(java.io.FileInputStream(keystorePropertiesFile))
          }
          
          configure<ApplicationExtension> {
              signingConfigs {
                  create("release") {
                      keyAlias = keystoreProperties.getProperty("keyAlias") ?: "upload"
                      keyPassword = keystoreProperties.getProperty("keyPassword") ?: "password"
                      storeFile = keystoreProperties.getProperty("storeFile")?.let { file(it) } ?: file("upload-keystore.jks")
                      storePassword = keystoreProperties.getProperty("storePassword") ?: "password"
                  }
              }
              buildTypes {
                  getByName("release") {
                      signingConfig = signingConfigs.getByName("release")
                  }
              }
          }
          EOF
          
          # Add apply to the build.gradle.kts
          echo "" >> android/app/build.gradle.kts
          echo "apply(from = file(\"signing.gradle.kts\"))" >> android/app/build.gradle.kts
      
      - run: flutter build apk --release --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-android
          path: app/build/app/outputs/flutter-apk/app-release.apk

  build_windows:
    name: Build Windows
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - run: bash ./set_app_name.sh
      - run: flutter pub get
      - run: flutter build windows --release --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      
      - name: Install NSIS
        run: |
           choco install nsis -y
           refreshenv
           
      - name: Create Installer
        shell: pwsh
        run: |
           $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
           & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
           
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-windows-installer
          path: app/FreeMail_Setup.exe

  build_linux:
    name: Build Linux (x64)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libayatana-appindicator3-dev
      
      - run: chmod +x ./set_app_name.sh
      - run: ./set_app_name.sh
      - run: flutter pub get
      - run: flutter build linux --release --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      
      - name: Package Zip
        run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../free-mail-linux-x64.zip .
          
      - name: Package Deb
        run: |
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/local/bin
          mkdir -p deb/usr/local/lib/free-mail
          cp -r build/linux/x64/release/bundle/* deb/usr/local/lib/free-mail/
          ln -s /usr/local/lib/free-mail/free_mail deb/usr/local/bin/free-mail
          
          cat > deb/DEBIAN/control <<EOF
          Package: free-mail
          Version: 1.0.0
          Section: mail
          Priority: optional
          Architecture: amd64
          Maintainer: CTO <admin@example.com>
          Description: Free Mail App
           A Flutter based email client.
          EOF
          
          dpkg-deb --build deb free-mail-linux-x64.deb
          
      - name: Package RPM
        run: |
           sudo apt-get install -y rpm alien
           sudo alien -r free-mail-linux-x64.deb
           
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-linux-x64
          path: |
            app/free-mail-linux-x64.zip
            app/free-mail-linux-x64.deb
            app/*.rpm

  build_ios:
    name: Build iOS (No Codesign)
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - run: chmod +x ./set_app_name.sh
      - run: ./set_app_name.sh
      - run: flutter pub get
      - run: flutter build ios --release --no-codesign --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-ios-app
          path: app/build/ios/iphoneos/Runner.app

  build_macos_intel:
    name: Build macOS (Intel)
    runs-on: macos-13
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - run: chmod +x ./set_app_name.sh
      - run: ./set_app_name.sh
      - run: flutter pub get
      - run: flutter config --enable-macos-desktop
      - run: flutter build macos --release --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      
      - name: Zip App
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../free-mail-macos-intel.zip Free\ Mail.app
          
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-macos-intel
          path: app/free-mail-macos-intel.zip

  build_macos_arm:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14
    defaults:
      run:
        working-directory: ./app
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - run: chmod +x ./set_app_name.sh
      - run: ./set_app_name.sh
      - run: flutter pub get
      - run: flutter config --enable-macos-desktop
      - run: flutter build macos --release --dart-define=BACKEND_URL=${{ vars.BACKEND_URL }}
      
      - name: Zip App
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../free-mail-macos-arm.zip Free\ Mail.app
          
      - uses: actions/upload-artifact@v4
        with:
          name: free-mail-macos-arm
          path: app/free-mail-macos-arm.zip

  create_release:
    name: Create GitHub Release
    needs: [build_android, build_windows, build_linux, build_ios, build_macos_intel, build_macos_arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Free-mail v${{ github.event.inputs.version }} (${{ github.event.inputs.release_type }})
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'beta' }}
          generate_release_notes: true
          files: |
            artifacts/free-mail-android/app-release.apk
            artifacts/free-mail-windows-installer/FreeMail_Setup.exe
            artifacts/free-mail-linux-x64/free-mail-linux-x64.zip
            artifacts/free-mail-linux-x64/free-mail-linux-x64.deb
            artifacts/free-mail-linux-x64/*.rpm
            artifacts/free-mail-ios-app/Runner.app
            artifacts/free-mail-macos-intel/free-mail-macos-intel.zip
            artifacts/free-mail-macos-arm/free-mail-macos-arm.zip
